Welcome back.

In this lecture, I will show you how to create a release pipeline.

So, let's start.

Login to your Azure DevOps portal.

Go to your project.

Choose the releases from the pipelines menu.

Hit the new release pipeline button.

We will use an empty job template for this project.

So, choose the empty job at the top right of the page.

Now, in the artifacts box, click the + Add button.

Now, we need to define the source for this release pipeline.

The project name is SBIT.

Click the source build pipeline drop box and choose your build pipeline.

So, this release pipeline will use your build pipeline as its source.

What does it mean?

Simple!

It will take the artifacts from the build pipeline.

Now, hit the Add button.

That's all.

The Artifact is defined for your release pipeline.

The next step is to define the stages of the pipeline.

We can have a single stage, as shown here.

However, we will define multiple tasks in the first stage.

Click the 0 task link in the Stage 1 box.

Now click the Agent job, and you can see the Agent job details.

Choose Azure Pipelines in the Agent selection.

The Agent Specification must be ubuntu-22.04.

Now, hit the save button at the top.

Press ok.

Great!

So, we added an Ubunto agent for our release pipeline.

The next step is to add tasks to run on the Ubuntu agent.

Click the plus button, and it will allow you to add a task.

Search for Use Python version and add it.

This will add the Use Python 3.x task to your agent.

Now click the Use Python 3.x, and it will allow you to modify the properties.

Change the display name to Use Python 3.10

Also, change the version spec to 3.10.

Then, hit the save button at the top.

The next step is to add a new task to Extract the build pipeline artifact.

Click the plus button again to add a new task.

Search for the Extract files task and add it.

Now select the Extract files task so you can modify the details.

Paste the command into the Destination folder.

The Release.PrimaryArtifactSourceAlias is a system variable, and Databricks is my artifact directory.

Hit the save button once again.

So, we installed Python 3.10 and extracted the artifact.

What is next?

The next step could be deploying the artifact to your Databricks workspace.

But for that, we will need Databricks CLI.

So, let me add a new task for installing Databricks CLI.

Click the plus button once again and search for Bash.

Add a Bash task.

Now click the Bash Script so you can define the details.

Change the Display name.

Under the Type of script, choose the inline radio button.

Replace the content of the text box with pip install databricks-cli

Great!

Now, we can add one more bash script to deploy the source code.

Let me click the plus button once again and add a bash task.

Now click the Bash Scrip so you can modify the properties.

Change the display name

Now, choose the inline radio button.

Replace the text box content with a databricks cli command.

Now save it again.

Great!

So, we created a release pipeline for deployment.

However, I want to add one more task for integration testing.

So, let me add one more task.

Click the plus button once again.

Search for Bash and add a bash task.

Now click the bash task so you can change the properties.

Change the display name

Choose the inline script.

Now, replace the content with a bash script to run the integration test.

Now, hit the save button.

The bash script to run the integration test is the most critical part of this build pipeline.

I will explain the script in a separate lecture.

But for now, you can learn that the script will do the following things.

Create a job to run the 08-batch-test notebook from the deployment folder.

Trigger the job and get the run id.

Wait for the job to complete while it is running

Delete the job after completion

Publish the job result

But how is all that coded?

I will explain the script later

For now, let's finish the pipeline and test it.

Great!

You can see the pipeline name at the top of the page.

Change the name of the pipeline

Then save it again.

That's all, we created the deploy pipeline.

However, the release pipeline needs to deploy your notebooks in your target Databricks workspace.

It will be using Databricks CLI for connecting to the target environment and deploying your code.

But for that, we need to supply the following information.

Databricks Workspace URL

and Access Token for Authentication

So, let's collect these two pieces of information, and then we will set these values in our pipeline.

Let me go to my Azure portal.

Click Azure Databricks at the top of the page.

Now you can see two workspaces.

The sbit-ws is my development workspace, and the sbit-qa is my qa workspace for the same project.

We want our release pipeline to deploy my project into the QA workspace.

So, let's go to the sbit-qa workspace and launch the workspace.

Great!

Now, I am inside the workspace.

I need two pieces of information to deploy my project in this environment.

Databricks Workspace URL

and Access Token for Authentication

Let's copy the workspace URL.

You can click the browser address bar and copy the URL up to the .net.

Make sure you do not have the / at the end.

Keep it somewhere safe, and we will use it in the release pipeline.

The next thing is to get an access token.

Go to your name at the top right corner of the page and click the user settings menu.

Come to the developer tab and hit the manage access tokens button.

Generate a new token.

Give a comment

Set the validity period.

I make it valid for 10 days only.

Hit the generate button.

Copy the token and save it somewhere because you cannot see this token again.

Done.

That's all.

We now have the URL and the access token.

Just click the workspace menu.

Expand the workspace to check the shared folder.

We do not see anything here.

Correct?

No files are there in the shared folder.

I am planning to deploy my project files in this shared folder.

You can have any other folder or subfolder structure for the deployment.

But in this example, we want to deploy the code in the shared folder directly.

Once the pipeline is complete, you can come here and see your project files.

Now, let's go back to our Azure DevOps release pipeline page.

Great!

So, this is my release pipeline.

Click the variables tab at the top.

Now add a new environment variable for DATABRICKS_HOST.

Paste the workspace URL in the value.

Add one more environment variable for DATABRICKS_TOKEN.

Now, paste the access token in the value.

Hit the save button at the top.

And that is all.

We finalized our release pipeline.

Great!

So, we created our build pipeline in the earlier lecture, and this lecture created the release pipeline.

The build pipeline is automatic.

So, as soon as you commit to any branch or raise a pull request, the build pipeline will start running.

The release pipeline is manual.

So once your build pipeline is complete

and you are ready to deploy your project into the QA environment,

you can manually trigger the release pipeline, and it will deploy your project.

Let's try both steps.

Go to the repos.

Choose the initial feature branch.

This is the branch we have been developing our project.

You can see all the code files here.

Correct?

Now, let's raise a pull request to merge these changes into the release branch.

What will happen?

The release branch build pipeline will start and prepare the artifact.

Correct?

Let's raise a pull request.

Change the target branch to the release branch.

Give a title

Come down and hit the create button.

Now click the complete button and complete the merge.

Great!

PR is merged.

Now go to the pipeline and click the pipelines.

Do you see your build name here with a green tick mark?

You can see it ran just now.

Click the build name, and you can see the PR details.

This build ran for the initial release PR.

Correct.

Click again, and you can see the job status.

It is a success.

Click the job, and you can see the list of tasks.

All the tasks are green.

If you want to see the logs for any task, click the task name.

For example, click the archive files task.

You can see the logs for this task.

Great!

So, our build pipeline is successful, and the artifact is ready for deployment.

Let's go and manually trigger the release pipeline.

Click the releases.

You will see your SBIT Deploy Pipeline.

Select it and hit the create release button.

That's how we run the release pipeline.

Now, hit the create button.

Great, the release pipeline is running.

Wait until you see the Stage 1 running.

It is running now.

Now, you can go to the deployments tab.

You can see stage 1 running here.

Click the stage 1, and you can see all the jobs.

Scroll up, and you will see some jobs marked with green as they are completed.

We still have the last Job running.

But this one is an integration test, so it is going to take some time.

Now, if you want, you can go to your sbit-qa environment.

Here I am.

Come to the workspace and shared folder.

Do you see all your notebooks?

They are deployed.

Come to the workflow tab,

and you will see one test job.

Go to job runs, and you can see your test job status.

Your build pipeline is waiting for this test job to be completed.

Once it is complete, you will see the release pipeline marked with green status.

And that is all.

So, we learned to create, build pipeline, and release pipelines.

We also created a pull request and saw it in action.

Then, we executed our release pipeline and saw the automated deployment and integration testing.

And that's all for this lecture.

See you again.

Keep Learning and Keep Growing.
